<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{board/board-layout :: html(
        'ê²Œì‹œê¸€ ì‘ì„±',
        ~{::head/link},
        ~{::#contents},
        ~{::script}
      )}">
<head>
    <!-- summernote -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">

    <style>
    </style>
</head>
<body>

<div id="contents">
    <h1 class="page-title">ê²Œì‹œê¸€ ì‘ì„±</h1>

    <div class="post-form">
        <form id="postForm" method="post">
            <div class="form-group">
                <label for="title">ì œëª©</label>
                <input type="text" id="title" name="title" class="form-control" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>

            <div class="form-group">
                <label for="boardId">ê²Œì‹œíŒ ìœ í˜•</label>
                <select id="boardId" name="boardId" class="select-control" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="1">ì‚¬ë‚´ê³µì§€</option>
                    <option value="2">ììœ ê²Œì‹œíŒ</option>
                    <option value="3">ì¶•êµ¬ë™í˜¸íšŒ</option>
                    <option value="4">ì˜í™”ë™í˜¸íšŒ</option>
                </select>
            </div>
            <div class="form-group">
                <label for="summernote">ë‚´ìš©</label>
                <textarea id="summernote" type="text" th:class="form-control" name="content" rows="10" required></textarea>
            </div>

            <!-- íŒŒì¼ ì²¨ë¶€ ì˜ì—­ ì¶”ê°€ -->
            <div class="form-group">
                <label>íŒŒì¼ ì²¨ë¶€</label>
                <div class="file-upload-container" id="file-drop-area">
                    <input type="file" id="file-upload-input" class="file-upload-input" multiple>
                    <div class="file-upload-prompt">
                        <div class="file-upload-icon">ğŸ“</div>
                        <p class="file-upload-text">íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <p class="file-upload-hint">ìµœëŒ€ 10ê°œ íŒŒì¼, ê° íŒŒì¼ 10MB ì´í•˜</p>
                    </div>
                </div>

                <ul class="file-list" id="file-list">
                    <!-- íŒŒì¼ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
            </div>

            <div class="form-actions">
                <button type="reset" class="btn">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- summernote -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.min.js"></script>
<script>
    $(document).ready(function() {
        // Summernote ì´ˆê¸°í™”
        $('#summernote').summernote({
            height: 300,
            lang: "ko-KR",
            focus: true,
            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”',
            toolbar: [
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['strikethrough']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview']]
            ],
            fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '20', '22', '24', '28', '30', '36'],
            callbacks: {
                onImageUpload: function(files) {
                    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
                    for (let i = 0; i < files.length; i++) {
                        uploadSummernoteImage(files[i], this);
                    }
                }
            }
        });

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
        function uploadSummernoteImage(file, editor) {
            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/api/posts/upload/image',  // ì„œë²„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')  // JWT ì¸ì¦ ì¶”ê°€
                },
                success: function(data) {
                    // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì´ë¯¸ì§€ URLì„ ì—ë””í„°ì— ì‚½ì…
                    $(editor).summernote('insertImage', data.url);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(textStatus + ' : ' + errorThrown);
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ë§
        const fileUploadInput = document.getElementById('file-upload-input');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileList = document.getElementById('file-list');
        const MAX_FILE_COUNT = 10;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        let fileData = []; // ì—…ë¡œë“œí•  íŒŒì¼ë“¤ì„ ì €ì¥í•  ë°°ì—´

        // íŒŒì¼ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            // íŒŒì¼ì„ ëŒê³  ì˜¬ ë•Œ ì˜ì—­ì— ê°•ì¡° ìŠ¤íƒ€ì¼ ì ìš©
            fileDropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            // íŒŒì¼ì„ ë†“ê±°ë‚˜ ì˜ì—­ì„ ë²—ì–´ë‚˜ë©´ ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µê·€
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            fileDropArea.style.borderColor = '#2563eb';
            fileDropArea.style.backgroundColor = '#dbeafe';
        }

        function unhighlight() {
            fileDropArea.style.borderColor = '#d1d5db';
            fileDropArea.style.backgroundColor = '#f3f4f6';
        }

        // ì‚¬ìš©ìê°€ íŒŒì¼ì„ ëŒì–´ì„œ ì´ ì˜ì—­ì— ë†“ì•˜ì„ ë•Œ handleDrop í•¨ìˆ˜ ì‹¤í–‰
        fileDropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer; // ë“œë¡­ëœ ë°ì´í„°ì—ì„œ ì •ë³´ë“¤ì„ ê°€ì ¸ì˜´
            const files = dt.files; // ê·¸ ì¤‘ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
            handleFiles(files); // íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì— ì „ë‹¬
        }

        fileUploadInput.addEventListener('change', function() {
            // íŒŒì¼ ì„ íƒ ì°½ì—ì„œ íŒŒì¼ì„ ê³ ë¥´ë©´ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì— ì „ë‹¬í•¨
            handleFiles(this.files);
        });

        function handleFiles(files) {
            if (fileData.length + files.length > MAX_FILE_COUNT) {
                alert(`ìµœëŒ€ ${MAX_FILE_COUNT}ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // íŒŒì¼ í¬ê¸° ê²€ì‚¬
                if (file.size > MAX_FILE_SIZE) {
                    alert(`íŒŒì¼ '${file.name}'ì´(ê°€) 10MB ì œí•œì„ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    continue;
                }

                // íŒŒì¼ ë°ì´í„° ì €ì¥
                const fileId = Date.now() + '-' + i;
                fileData.push({
                    id: fileId,
                    file: file
                });

                // íŒŒì¼ í•­ëª© UI ì¶”ê°€
                addFileItem(file, fileId);
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            fileUploadInput.value = '';
        }

        function addFileItem(file, fileId) {
            const fileItem = document.createElement('li');
            fileItem.className = 'file-item';
            fileItem.dataset.fileId = fileId;

            const fileSize = formatFileSize(file.size);
            const fileType = getFileType(file.name); // íŒŒì¼ ì´ë¦„ì—ì„œ í™•ì¥ìë¥¼ ì¶”ì¶œí•˜ì—¬ íŒŒì¼ ìœ í˜•ì„ íŒë‹¨í•¨

            fileItem.innerHTML = `
                <div class="file-info">
                    <span class="file-icon">${getFileIconByType(fileType)}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${fileSize}</span>
                </div>
                <button type="button" class="file-remove" data-file-id="${fileId}">Ã—</button>
            `;

            // ìƒì„±í•œ íŒŒì¼ í•­ëª©ì„ íŒŒì¼ ëª©ë¡ì— ì¶”ê°€í•¨
            fileList.appendChild(fileItem);

            // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
            const removeBtn = fileItem.querySelector('.file-remove');
            removeBtn.addEventListener('click', function() {
                const fileId = this.dataset.fileId;
                removeFile(fileId);
            });
        }

        function removeFile(fileId) {
            // ë°°ì—´ì—ì„œ íŒŒì¼ ë°ì´í„° ì œê±°
            fileData = fileData.filter(item => item.id !== fileId);

            // UIì—ì„œ íŒŒì¼ í•­ëª© ì œê±°
            const fileItem = fileList.querySelector(`li[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();

            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext)) {
                return 'image';
            } else if (['doc', 'docx', 'rtf', 'txt'].includes(ext)) {
                return 'document';
            } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
                return 'spreadsheet';
            } else if (['ppt', 'pptx'].includes(ext)) {
                return 'presentation';
            } else if (['pdf'].includes(ext)) {
                return 'pdf';
            } else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
                return 'archive';
            } else {
                return 'other';
            }
        }

        function getFileIconByType(fileType) {
            switch (fileType) {
                case 'image': return 'ğŸ–¼ï¸';
                case 'document': return 'ğŸ“„';
                case 'spreadsheet': return 'ğŸ“Š';
                case 'presentation': return 'ğŸ“‘';
                case 'pdf': return 'ğŸ“•';
                case 'archive': return 'ğŸ“¦';
                default: return 'ğŸ“';
            }
        }


        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('#postForm').on('submit', function(e) {
            e.preventDefault();

            // FormData ê°ì²´ ìƒì„±
            const formData = new FormData();

            // ê²Œì‹œê¸€ ê¸°ë³¸ ì •ë³´ ì¶”ê°€
            formData.append('title', $('#title').val());
            formData.append('content', $('#summernote').summernote('code'));
            formData.append('boardId', $('#boardId').val());

            // íŒŒì¼ ì²¨ë¶€ ì¶”ê°€ - fileData ë°°ì—´ì˜ íŒŒì¼ì„ ì‚¬ìš©
            if (fileData.length > 0) {
                fileData.forEach(fileItem => {
                    formData.append('files', fileItem.file);
                });
            }

            // API í˜¸ì¶œ
            $.ajax({
                url: '/api/posts',  // íŒŒì¼ ì²¨ë¶€ í¬í•¨ ê²Œì‹œê¸€ ì €ì¥ API
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')  // JWT ì¸ì¦ ì¶”ê°€
                },
                success: function(data) {
                    // ì„±ê³µ ì²˜ë¦¬
                    alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/board'; // ê²Œì‹œê¸€ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // ì˜¤ë¥˜ ì²˜ë¦¬
                    alert('ê²Œì‹œê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (jqXHR.responseJSON?.message || errorThrown));
                    console.error('Error:', jqXHR.responseJSON || errorThrown);
                }
            });
        });

    });
</script>
</body>
</html>