<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¸ë£¹ì›¨ì–´ ì‹œìŠ¤í…œ - ëŒ€ì‹œë³´ë“œ</title>

    <!-- í°íŠ¸ ë° ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- ë©”ì¸ í˜ì´ì§€ CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/main-page.css}">

    <!-- í—¤ë” ì—ì…‹ í¬í•¨ -->
    <th:block th:replace="fragments/header :: headerAssets"></th:block>

    <!-- ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ í¬í•¨ -->
    <link rel="stylesheet" th:href="@{/assets/css/fragments/sidebar-common.css}">

    <script src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.8/index.global.min.js"></script>

    <style>
        /* ë°˜ì‘í˜•: ì‚¬ì´ë“œë°”ê°€ í† ê¸€ë  ë•Œ */
        @media (max-width: 1200px) {
            /*í˜ì´ì§€ ë‚´ë¹„ê²Œì´ì…˜ í† ê¸€ ë²„íŠ¼*/
            .gw-current-page {
                display: block !important;
            }
        }
    </style>
</head>
<body>

<!-- í—¤ë” í¬í•¨ -->
<div th:replace="fragments/header :: header"></div>

<div class="main-container">
    <!-- ì‚¬ì´ë“œë°” -->
    <div th:replace="fragments/sidebar/main-sidebar :: sidebar"></div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <!-- í”„ë¡œí•„ ë° ê²Œì‹œíŒ ì„¹ì…˜ -->
        <div class="dashboard-row">
            <div class="dashboard-section section-left">
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-image">
                            <img th:src="${employee.profileImgUrl}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                        </div>
                        <div class="profile-name">
                            <h3 th:text="${employee.name + ' ' + employee.positionTitle}"></h3>
                            <p th:text="${employee.departmentName}"></p>
                        </div>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-label">ê²°ì¬í•  ë¬¸ì„œ</div>
                            <div class="stat-value" th:text="${edsmCount}"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ë‚´ ì˜ˆì•½/ëŒ€ì—¬ í˜„í™©</div>
                            <div class="stat-value" th:text="${myBookingsCount}"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section section-right">
                <h4 class="card-title">ê²Œì‹œíŒ</h4>

                <div class="tabs-container">
                    <div class="tabs-navigation">
                        <button class="tab-button active" data-tab="notice">ì‚¬ë‚´ê³µì§€</button>
                        <button class="tab-button" data-tab="free">ììœ ê²Œì‹œíŒ</button>
                    </div>

                    <div id="notice" class="tab-content active">
                        <!-- ê³µì§€ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° -->
                        <div th:if="${!notices.isEmpty()}">
                            <div class="list-group">
                                <a th:each="notice, index : ${notices}"
                                   th:href="${notice.url}"
                                   th:text="${notice.title}"
                                   class="list-group-item list-group-item-action"
                                   target="_blank">
                                    ê³µì§€ì‚¬í•­ ì œëª©
                                </a>
                            </div>
                        </div>

                        <!-- ê³µì§€ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš° -->
                        <div th:if="${notices.isEmpty()}" class="alert">
                            í‘œì‹œí•  ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>

                    <!-- ììœ ê²Œì‹œíŒ -->
                    <div id="free" class="tab-content">
                        <div th:if="${!publicList.isEmpty()}">
                            <div class="list-group">
                                <a th:each="post : ${publicList}"
                                   th:href="@{/board/post/{id}(id=${post.id})}"
                                   class="list-group-item list-group-item-action"
                                   target="_blank"
                                   style="display: flex; justify-content: space-between; align-items: center;">

                                    <span th:text="${post.title}">ì œëª©</span>
                                    <span th:text="${post.author}" style="font-size: 0.85em; color: #666;">ì‘ì„±ì</span>
                                </a>
                            </div>
                        </div>
                        <!-- ê²Œì‹œê¸€ì´ ì—†ëŠ” ê²½ìš° -->
                        <div th:if="${publicList.isEmpty()}" class="alert">
                            í‘œì‹œí•  ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê·¼íƒœ ë° íšŒì˜ì‹¤ ì˜ˆì•½ ì„¹ì…˜ -->
        <div class="dashboard-row">
            <div class="dashboard-section section-left">
                <h4 class="card-title">ê·¼íƒœê´€ë¦¬</h4>
                <p class="date-info" id="current-time">2025ë…„ 03ì›” 26ì¼ (í™”) 10:56:43</p>

                <div class="attendance-info">
                    <div class="attendance-row">
                        <div class="attendance-label">ì¶œê·¼ì‹œê°„</div>
                        <div class="attendance-value"
                             th:each="attendance : ${attendanceListByDate}"
                             th:if="${attendance.checkIn != null}" th:text="${attendance.checkIn}">
                        </div>
                    </div>
                    <div class="attendance-row">
                        <div class="attendance-label">í‡´ê·¼ì‹œê°„</div>
                        <div class="attendance-value"
                             th:each="attendance : ${attendanceListByDate}"
                             th:if="${attendance.checkOut != null}" th:text="${attendance.checkOut}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section section-right">
                <h4 class="card-title">íšŒì˜ì‹¤ ì˜ˆì•½ í˜„í™©</h4>
                <div class="timetable-container">
                    <table class="timetable">
                        <thead>
                        <tr>
                            <th></th>
                            <th>09:00</th>
                            <th>10:00</th>
                            <th>11:00</th>
                            <th>12:00</th>
                            <th>13:00</th>
                            <th>14:00</th>
                            <th>15:00</th>
                            <th>16:00</th>
                            <th>17:00</th>
                            <th>18:00</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- íšŒì˜ì‹¤ë³„ ì˜ˆì•½ í˜„í™© í‘œì‹œ -->
                        <tr th:each="roomNumber : ${#numbers.sequence(1, 4)}">
                            <td th:text="${'íšŒì˜ì‹¤'+roomNumber}">íšŒì˜ì‹¤</td>
                            <!-- ìˆ˜ì •ëœ ë¶€ë¶„: colspanì„ 11ë¡œ ë³€ê²½í•˜ì—¬ 18:00ê¹Œì§€ í¬í•¨ -->
                            <td colspan="10" style="position: relative;">
                                <!-- í•´ë‹¹ íšŒì˜ì‹¤ì˜ ì˜ˆì•½ë§Œ í•„í„°ë§í•˜ì—¬ í‘œì‹œ -->
                                <div th:each="booking : ${meetingRoomBookings}"
                                     th:if="${booking.roomId == roomNumber}"
                                     class="reservation-bar"
                                     th:style="${'width: ' + bookingUtils.calculateWidth(booking) + '%; left: ' + bookingUtils.calculatePosition(booking) + '%; background-color: ' + bookingUtils.getBookingColor(booking)}">
                                    <span th:text="${@stringUtils.removeFirstNChars(bookingUtils.formatBookingTime(booking), 3)}">ì˜ˆì•½ ì‹œê°„</span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- í”„ë¡œì íŠ¸ ë° ì—…ë¬´ í˜„í™© ì„¹ì…˜ (ê¸°ì¡´ API í™œìš©) -->
        <div class="dashboard-row">
            <div class="dashboard-section section-left" onclick="location.href='/workmanagement'" style="cursor: pointer;">
                <h4 class="card-title">ë‚´ í”„ë¡œì íŠ¸ í˜„í™©</h4>
                <div class="project-stats">
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">ì§„í–‰ì¤‘</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">ì¤€ë¹„ì¤‘</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">ì§€ì—°</div>
                    </div>
                </div>
                <div class="project-list">
                    <!-- í”„ë¡œì íŠ¸ ì•„ì´í…œë“¤ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i> í”„ë¡œì íŠ¸ ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>

            <div class="dashboard-section section-right" onclick="location.href='/workmanagement'" style="cursor: pointer;">
                <h4 class="card-title">ì—…ë¬´ í˜„í™©</h4>
                <div class="task-status">
                    <div class="task-chart">
                        <div class="donut-chart" id="taskChart">
                            <!-- ì°¨íŠ¸ ì„¸ê·¸ë¨¼íŠ¸ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->

                        </div>
                    </div>
                    <div class="task-legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #4caf50;"></span>
                            <span class="legend-text">ì™„ë£Œ</span>
                            <span class="legend-value">0</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #2196f3;"></span>
                            <span class="legend-text">ì§„í–‰ì¤‘</span>
                            <span class="legend-value">0</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ff9800;"></span>
                            <span class="legend-text">ëŒ€ê¸°ì¤‘</span>
                            <span class="legend-value">0</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #f44336;"></span>
                            <span class="legend-text">ì§€ì—°</span>
                            <span class="legend-value">0</span>
                        </div>
                    </div>
                </div>
                <div class="recent-tasks">
                    <h5>ìµœê·¼ ì—…ë¬´</h5>
                    <ul class="task-list">
                        <!-- ì—…ë¬´ ì•„ì´í…œë“¤ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        <li class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> ì—…ë¬´ ë¡œë”© ì¤‘...
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- í•  ì¼ ëª©ë¡ ì„¹ì…˜ -->
        <div class="dashboard-row">
            <div class="dashboard-section section-full" style="cursor: pointer;">
                <h4 class="card-title">ë‚´ í•  ì¼ ëª©ë¡</h4>
                <div class="todo-container">
                    <div class="todo-input">
                        <input type="text" id="todoInput" placeholder="ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="addTodoBtn"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul id="todoList" class="todo-list">
                        <li th:each="todo : ${todos}" th:if="${todos != null && !todos.isEmpty()}" class="todo-item">
                            <div class="todo-check">
                                <input type="checkbox" th:id="${'todo-' + todo.id}" th:checked="${todo.completed}">
                                <label th:for="${'todo-' + todo.id}" th:class="${todo.completed ? 'completed' : ''}">
                                    <span th:text="${todo?.content ?: 'ì£¼ê°„ íšŒì˜ ì¤€ë¹„ìë£Œ ë§Œë“¤ê¸°'}">ì£¼ê°„ íšŒì˜ ì¤€ë¹„ìë£Œ ë§Œë“¤ê¸°</span>
                                </label>
                            </div>
                            <div class="todo-actions">
                                <span class="todo-date" th:text="${todo?.date ?: '2025-04-18'}">2025-04-18</span>
                                <button class="todo-delete"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </li>
                        <!-- í•  ì¼ì´ ì—†ëŠ” ê²½ìš° -->
                        <li th:if="${todos == null || todos.isEmpty()}" class="no-data-message">
                            í•  ì¼ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- íšŒì‚¬ ë¸Œëœë“œ ìŠ¤í† ë¦¬í…”ë§ ì„¹ì…˜ -->
        <div class="dashboard-row">
            <div class="dashboard-section section-full brand-storytelling">
                <h4 class="card-title">ìš°ë¦¬ íšŒì‚¬ì˜ í•µì‹¬ ê°€ì¹˜</h4>

                <div class="brand-values-container">
                    <!-- í•µì‹¬ ê°€ì¹˜ ìºëŸ¬ì…€ -->
                    <div class="values-carousel">
                        <div class="value-item active" data-value="innovation">
                            <div class="value-icon"><i class="fas fa-lightbulb"></i></div>
                            <h3 class="value-title">í˜ì‹ </h3>
                            <p class="value-description">ëŠì„ì—†ëŠ” ë„ì „ê³¼ ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ í†µí•´ ì‚°ì—…ì˜ í‘œì¤€ì„ ì¬ì •ì˜í•©ë‹ˆë‹¤.</p>
                        </div>

                        <div class="value-item" data-value="collaboration">
                            <div class="value-icon"><i class="fas fa-users"></i></div>
                            <h3 class="value-title">í˜‘ì—…</h3>
                            <p class="value-description">ë‹¤ì–‘í•œ ë°°ê²½ê³¼ ê´€ì ì´ ë§Œë‚˜ ì‹œë„ˆì§€ë¥¼ ì°½ì¶œí•˜ëŠ” í™˜ê²½ì„ ë§Œë“­ë‹ˆë‹¤.</p>
                        </div>

                        <div class="value-item" data-value="integrity">
                            <div class="value-icon"><i class="fas fa-shield-alt"></i></div>
                            <h3 class="value-title">ì •ì§</h3>
                            <p class="value-description">ì‹ ë¢°ì™€ íˆ¬ëª…ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ëª¨ë“  ì´í•´ê´€ê³„ìì™€ì˜ ê´€ê³„ë¥¼ í˜•ì„±í•©ë‹ˆë‹¤.</p>
                        </div>

                        <div class="value-item" data-value="excellence">
                            <div class="value-icon"><i class="fas fa-award"></i></div>
                            <h3 class="value-title">íƒì›”í•¨</h3>
                            <p class="value-description">ìµœê³  ìˆ˜ì¤€ì˜ ì „ë¬¸ì„±ê³¼ í’ˆì§ˆì„ í†µí•´ ê³ ê°ì—ê²Œ ê°€ì¹˜ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
                        </div>

                        <div class="value-item" data-value="responsibility">
                            <div class="value-icon"><i class="fas fa-hands-helping"></i></div>
                            <h3 class="value-title">ì±…ì„</h3>
                            <p class="value-description">ì‚¬íšŒì™€ í™˜ê²½ì— ëŒ€í•œ ì±…ì„ì„ ë‹¤í•˜ë©° ì§€ì† ê°€ëŠ¥í•œ ì„±ì¥ì„ ì¶”êµ¬í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
                    <div class="carousel-navigation">
                        <button class="nav-button prev"><i class="fas fa-chevron-left"></i></button>
                        <div class="navigation-dots">
                            <span class="dot active" data-index="0"></span>
                            <span class="dot" data-index="1"></span>
                            <span class="dot" data-index="2"></span>
                            <span class="dot" data-index="3"></span>
                            <span class="dot" data-index="4"></span>
                        </div>
                        <button class="nav-button next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- íšŒì‚¬ ë¯¸ì…˜ ë¬¸êµ¬ -->
                <div class="company-mission">
                    <p class="mission-text">"í˜ì‹ ì ì¸ ê¸°ìˆ ê³¼ ì¸ê°„ ì¤‘ì‹¬ì˜ ì„œë¹„ìŠ¤ë¡œ ë” ë‚˜ì€ ë¯¸ë˜ë¥¼ ë§Œë“¤ì–´ê°‘ë‹ˆë‹¤"</p>
                    <div class="mission-graphic">
                        <div class="graphic-line"></div>
                        <div class="graphic-circle"></div>
                        <div class="graphic-line"></div>
                    </div>
                </div>

                <!-- íšŒì‚¬ ë§ˆì¼ìŠ¤í†¤ -->
                <div class="company-milestones">
                    <div class="milestone">
                        <div class="milestone-year">2010</div>
                        <div class="milestone-content">íšŒì‚¬ ì„¤ë¦½</div>
                    </div>
                    <div class="milestone">
                        <div class="milestone-year">2015</div>
                        <div class="milestone-content">ì£¼ìš” ì œí’ˆ ì¶œì‹œ</div>
                    </div>
                    <div class="milestone">
                        <div class="milestone-year">2020</div>
                        <div class="milestone-content">ê¸€ë¡œë²Œ ì‹œì¥ ì§„ì¶œ</div>
                    </div>
                    <div class="milestone">
                        <div class="milestone-year">2025</div>
                        <div class="milestone-content">ìƒˆë¡œìš´ ë¹„ì „ ì„ í¬</div>
                    </div>
                </div>

                <!-- í’‹í„° ë¬¸êµ¬ -->
                <div class="footer-quote">
                    <p>ì˜¤ëŠ˜ë„ í•¨ê»˜ ì„±ì¥í•˜ëŠ” <span class="highlight">TechX</span>ê°€ ë˜ê² ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ìº˜ë¦°ë” -->
        <div class="dashboard-row">
            <div class="dashboard-section section-full">
                <div class="calendar-wrapper">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {

        loadProjectsAndTasks();
        // íƒ­ ì „í™˜ ê¸°ëŠ¥
        const tabButtons = document.querySelectorAll('.tab-button');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // í´ë¦­ëœ íƒ­ í™œì„±í™”
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // FullCalendar ì´ˆê¸°í™”
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            googleCalendarApiKey: 'AIzaSyAmxOp9PrC83LxO6JmGFH3_rfhvpzOXiy8',
            initialView: 'dayGridMonth',
            locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },
            eventSources: [
                {
                    googleCalendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
                    className: 'korean-holiday'
                },
                {
                    events: [
                        {
                            title: 'íšŒì‚¬ì°½ë¦½ì¼ ğŸ‰',
                            start: '2012-04-24', // ì›í•˜ëŠ” ë‚ ì§œ (YYYY-MM-DD)
                            allDay: true,
                            className: 'company-anniversary' // ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ìœ„í•´ í´ë˜ìŠ¤ ì¶”ê°€ ê°€ëŠ¥
                        }
                    ]
                }
            ],
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                alert(info.event.title);
            }
        });
        calendar.render();

        // í•  ì¼ ëª©ë¡ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ê¸°ëŠ¥
        const todoInput = document.getElementById('todoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList');

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        loadTodosFromLocalStorage();

        addTodoBtn.addEventListener('click', addTodo);

        todoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        // ê¸°ì¡´ í•  ì¼ ì•„ì´í…œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        function attachEventListeners() {
            document.querySelectorAll('.todo-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const todoItem = this.closest('.todo-item');
                    deleteTodo(todoItem);
                });
            });

            document.querySelectorAll('.todo-check input').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const todoItem = this.closest('.todo-item');
                    const todoId = todoItem.dataset.id;
                    const label = this.nextElementSibling;

                    if (this.checked) {
                        label.classList.add('completed');
                    } else {
                        label.classList.remove('completed');
                    }

                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                    updateTodoInLocalStorage(todoId, this.checked);
                });
            });
        }

        // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        attachEventListeners();
    });

    // ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTime() {
        var currentDate = new Date();
        var year = currentDate.getFullYear();
        var month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        var date = currentDate.getDate().toString().padStart(2, '0');
        var day = currentDate.toLocaleString('ko-KR', { weekday: 'long' });
        var hours = currentDate.getHours().toString().padStart(2, '0');
        var minutes = currentDate.getMinutes().toString().padStart(2, '0');
        var seconds = currentDate.getSeconds().toString().padStart(2, '0');

        var formattedTime = `${year}ë…„ ${month}ì›” ${date}ì¼ (${day}) ${hours}:${minutes}:${seconds}`;
        document.getElementById('current-time').textContent = formattedTime;
    }

    // 1ì´ˆë§ˆë‹¤ updateTime í•¨ìˆ˜ ì‹¤í–‰
    setInterval(updateTime, 1000);

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í•  ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadTodosFromLocalStorage() {
        const todoList = document.getElementById('todoList');
        const todos = JSON.parse(localStorage.getItem('todos') || '[]');

        // í•  ì¼ ëª©ë¡ ì´ˆê¸°í™”
        todoList.innerHTML = '';

        if (todos.length === 0) {
            const noDataMessage = document.createElement('li');
            noDataMessage.className = 'no-data-message';
            noDataMessage.textContent = 'í•  ì¼ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!';
            todoList.appendChild(noDataMessage);
            return;
        }

        // ë‚ ì§œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
        todos.sort((a, b) => new Date(b.date) - new Date(a.date));

        // í•  ì¼ ëª©ë¡ ë Œë”ë§
        todos.forEach(todo => {
            addTodoToUI(todo);
        });
    }

    // í•  ì¼ ì¶”ê°€ í•¨ìˆ˜
    function addTodo() {
        const todoInput = document.getElementById('todoInput');
        const todoText = todoInput.value.trim();

        if (todoText === '') return;

        // í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        const today = new Date();
        const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

        // ìƒˆ í•  ì¼ ìƒì„±
        const newTodo = {
            id: Date.now().toString(), // ê³ ìœ  ID ìƒì„±
            content: todoText,
            completed: false,
            date: formattedDate
        };

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        const todos = JSON.parse(localStorage.getItem('todos') || '[]');
        todos.push(newTodo);
        localStorage.setItem('todos', JSON.stringify(todos));

        // UIì— ì¶”ê°€
        addTodoToUI(newTodo);
        todoInput.value = '';
    }

    // UIì— í•  ì¼ ì¶”ê°€
    function addTodoToUI(todo) {
        const todoList = document.getElementById('todoList');

        // "í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì œê±°
        const noDataMessage = todoList.querySelector('.no-data-message');
        if (noDataMessage) {
            todoList.removeChild(noDataMessage);
        }

        const li = document.createElement('li');
        li.className = 'todo-item';
        li.dataset.id = todo.id;

        li.innerHTML = `
      <div class="todo-check">
        <input type="checkbox" id="todo-${todo.id}" ${todo.completed ? 'checked' : ''}>
        <label for="todo-${todo.id}" class="${todo.completed ? 'completed' : ''}">
          <span>${todo.content}</span>
        </label>
      </div>
      <div class="todo-actions">
        <span class="todo-date">${todo.date}</span>
        <button class="todo-delete"><i class="fas fa-trash-alt"></i></button>
      </div>
    `;

        todoList.prepend(li);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const deleteBtn = li.querySelector('.todo-delete');
        deleteBtn.addEventListener('click', function() {
            deleteTodo(li);
        });

        const checkbox = li.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
            const label = this.nextElementSibling;
            const todoId = li.dataset.id;

            if (this.checked) {
                label.classList.add('completed');
            } else {
                label.classList.remove('completed');
            }

            updateTodoInLocalStorage(todoId, this.checked);
        });
    }

    // í•  ì¼ ì‚­ì œ
    function deleteTodo(todoItem) {
        const todoId = todoItem.dataset.id;

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚­ì œ
        let todos = JSON.parse(localStorage.getItem('todos') || '[]');
        todos = todos.filter(todo => todo.id !== todoId);
        localStorage.setItem('todos', JSON.stringify(todos));

        // UIì—ì„œ ì‚­ì œ
        todoItem.remove();

        // ëª©ë¡ì´ ë¹„ì—ˆëŠ”ì§€ í™•ì¸
        const todoList = document.getElementById('todoList');
        if (todoList.children.length === 0) {
            const noDataMessage = document.createElement('li');
            noDataMessage.className = 'no-data-message';
            noDataMessage.textContent = 'í•  ì¼ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!';
            todoList.appendChild(noDataMessage);
        }
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í•  ì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateTodoInLocalStorage(todoId, completed) {
        let todos = JSON.parse(localStorage.getItem('todos') || '[]');
        todos = todos.map(todo => {
            if (todo.id === todoId) {
                return { ...todo, completed: completed };
            }
            return todo;
        });

        localStorage.setItem('todos', JSON.stringify(todos));
    }

    /**
     * í”„ë¡œì íŠ¸ ë° ì—…ë¬´ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
     */
    function loadProjectsAndTasks() {
        // í”„ë¡œì íŠ¸ ë¡œë“œ
        fetch('/api/projects/my-projects')
            .then(response => {
                if (!response.ok) {
                    throw new Error('í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(projects => {
                // ì™„ë£Œë˜ì§€ ì•Šì€ í”„ë¡œì íŠ¸ë§Œ í•„í„°ë§
                const ongoingProjects = projects.filter(project => project.status !== 'ì™„ë£Œ');

                // í”„ë¡œì íŠ¸ ìƒíƒœë³„ í†µê³„ ê³„ì‚°
                const projectStats = calculateProjectStats(ongoingProjects);

                // í™”ë©´ ì—…ë°ì´íŠ¸
                updateProjectStats(projectStats);
                displayProjects(ongoingProjects);
            })
            .catch(error => {
                console.error('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ì²´ ë°ì´í„° ì‚¬ìš©
                const fallbackProjects = [
                    { id: 1, name: 'ì „ì‚¬ ë§ˆì¼€íŒ… ìº í˜ì¸', progress: 65, status: 'ì§„í–‰ì¤‘' },
                    { id: 2, name: 'ì‹ ê·œ ì„œë¹„ìŠ¤ ì¶œì‹œ', progress: 30, status: 'ì§„í–‰ì¤‘' },
                    { id: 3, name: 'ì›¹ì‚¬ì´íŠ¸ ë¦¬ë‰´ì–¼', progress: 85, status: 'ì§„í–‰ì¤‘' }
                ];

                const fallbackStats = calculateProjectStats(fallbackProjects);
                updateProjectStats(fallbackStats);
                displayProjects(fallbackProjects);
            });

        // ì—…ë¬´ ë¡œë“œ
        fetch('/api/tasks/my-tasks')
            .then(response => {
                if (!response.ok) {
                    throw new Error('ì—…ë¬´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(tasks => {
                // ì—…ë¬´ ìƒíƒœë³„ í†µê³„ ê³„ì‚°
                const taskStats = calculateTaskStats(tasks);

                // ìµœê·¼ ì—…ë¬´ 3ê°œ ì¶”ì¶œ (ë¯¸ì™„ë£Œ & ë§ˆê°ì¼ ìˆœ)
                const recentTasks = tasks
                    .filter(task => task.status !== 'ì™„ë£Œ')
                    .sort((a, b) => {
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    })
                    .slice(0, 3); // ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ

                // í™”ë©´ ì—…ë°ì´íŠ¸
                updateTaskStats(taskStats);
                displayRecentTasks(recentTasks);
            })
            .catch(error => {
                console.error('ì—…ë¬´ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ì²´ ë°ì´í„° ì‚¬ìš©
                const fallbackTasks = [
                    { id: 1, title: 'ë¶„ê¸°ë³„ ë³´ê³ ì„œ ì‘ì„±', dueDate: '2025-04-30', status: 'ì§„í–‰ì¤‘' },
                    { id: 2, title: 'í”„ë¡œì íŠ¸ ë¯¸íŒ… ì¤€ë¹„', dueDate: '2025-04-22', status: 'ë¯¸ì‹œì‘' },
                    { id: 3, title: 'ë§ˆì¼€íŒ… ìë£Œ ê²€í† ', dueDate: '2025-04-25', status: 'ì§„í–‰ì¤‘' }
                ];

                const fallbackStats = {
                    completed: 12,
                    inProgress: 8,
                    pending: 5,
                    delayed: 2
                };

                updateTaskStats(fallbackStats);
                displayRecentTasks(fallbackTasks);
            });
    }

    /**
     * í”„ë¡œì íŠ¸ ìƒíƒœë³„ í†µê³„ ê³„ì‚° í•¨ìˆ˜
     */
    function calculateProjectStats(projects) {
        const stats = {
            ongoing: 0,
            preparing: 0,
            delayed: 0
        };

        projects.forEach(project => {
            if (project.status === 'ì§„í–‰ì¤‘') {
                stats.ongoing++;
            } else if (project.status === 'ì¤€ë¹„ì¤‘') {
                stats.preparing++;
            } else if (project.status === 'ì§€ì—°') {
                stats.delayed++;
            }
        });

        return stats;
    }


    /**
     * ì—…ë¬´ ìƒíƒœë³„ í†µê³„ ê³„ì‚° í•¨ìˆ˜
     */
    function calculateTaskStats(tasks) {
        const stats = {
            completed: 0,
            inProgress: 0,
            pending: 0,
            delayed: 0
        };

        tasks.forEach(task => {
            if (task.status === 'ì™„ë£Œ') {
                stats.completed++;
            } else if (task.status === 'ì§„í–‰ì¤‘') {
                stats.inProgress++;
            } else if (task.status === 'ë¯¸ì‹œì‘') {
                stats.pending++;
            } else if (task.overdue || (task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'ì™„ë£Œ')) {
                stats.delayed++;
            }
        });

        return stats;
    }


    /**
     * í”„ë¡œì íŠ¸ í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
     */
    function updateProjectStats(stats) {
        if (!stats) return;

        // ìƒíƒœë³„ í”„ë¡œì íŠ¸ ìˆ˜ ì—…ë°ì´íŠ¸
        document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = stats.ongoing || 0;
        document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = stats.preparing || 0;
        document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = stats.delayed || 0;
    }

    /**
     * ì—…ë¬´ í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
     */
    function updateTaskStats(stats) {
        if (!stats) return;

        // ìƒíƒœë³„ ì—…ë¬´ ìˆ˜ ì—…ë°ì´íŠ¸
        document.querySelector('.legend-item:nth-child(1) .legend-value').textContent = stats.completed || 0;
        document.querySelector('.legend-item:nth-child(2) .legend-value').textContent = stats.inProgress || 0;
        document.querySelector('.legend-item:nth-child(3) .legend-value').textContent = stats.pending || 0;
        document.querySelector('.legend-item:nth-child(4) .legend-value').textContent = stats.delayed || 0;

        // ê°œì„ ëœ ë„ë„› ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateDonutChart(stats);
    }

    /**
     * ë„ë„› ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
     */
    function updateDonutChart(stats) {
        const chartElement = document.getElementById('taskChart');
        if (!chartElement) return;

        const total = stats.completed + stats.inProgress + stats.pending + stats.delayed;

        if (total === 0) {
            chartElement.innerHTML = '<div class="no-data-message">ë°ì´í„° ì—†ìŒ</div>';
            return;
        }

        const completedPercent = (stats.completed / total) * 100;
        const inProgressPercent = (stats.inProgress / total) * 100;
        const pendingPercent = (stats.pending / total) * 100;
        const delayedPercent = (stats.delayed / total) * 100;

        chartElement.style.background = `conic-gradient(
        #4caf50 0% ${completedPercent}%,
        #2196f3 ${completedPercent}% ${completedPercent + inProgressPercent}%,
        #ff9800 ${completedPercent + inProgressPercent}% ${completedPercent + inProgressPercent + pendingPercent}%,
        #f44336 ${completedPercent + inProgressPercent + pendingPercent}% 100%
    )`;
    }



    /**
     * ë„ë„› ì°¨íŠ¸ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„± í•¨ìˆ˜
     */
    function createDonutSegment(chartElement, percentage, color) {
        const segment = document.createElement('div');
        segment.className = 'donut-segment';
        segment.style.setProperty('--percentage', percentage);
        segment.style.setProperty('--fill', color);
        chartElement.appendChild(segment);
    }

    // ì°¨íŠ¸ ì„¸ê·¸ë¨¼íŠ¸ ì¶”ê°€ í•¨ìˆ˜
    function addChartSegment(chartElement, startAngle, percentage, color) {
        // ê°ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
        const endAngle = startAngle + (percentage / 100) * 360;

        // 180ë„ ì´ìƒì¸ì§€ í™•ì¸ (ë°˜ì› ì´ìƒ)
        const largeArcFlag = percentage > 50 ? 1 : 0;

        // ì²« ë²ˆì§¸ ë°˜ì› ì„¸ê·¸ë¨¼íŠ¸ (0-180ë„)
        const segment = document.createElement('div');
        segment.className = 'chart-segment';

        // ë‚´ë¶€ ì„¸ê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ë§
        const segmentInner = document.createElement('div');
        segmentInner.className = 'segment-inner';
        segmentInner.style.backgroundColor = color;
        segmentInner.style.transform = `rotate(${startAngle}deg)`;

        segment.appendChild(segmentInner);
        chartElement.appendChild(segment);

        // 180ë„ ì´ìƒì¸ ê²½ìš° ë‘ ë²ˆì§¸ ë°˜ì› ì„¸ê·¸ë¨¼íŠ¸ ì¶”ê°€ (180-360ë„)
        if (endAngle > startAngle + 180) {
            const segment2 = document.createElement('div');
            segment2.className = 'chart-segment';
            segment2.style.transform = 'rotate(180deg)';

            const segmentInner2 = document.createElement('div');
            segmentInner2.className = 'segment-inner';
            segmentInner2.style.backgroundColor = color;
            segmentInner2.style.transform = `rotate(${Math.max(0, startAngle - 180)}deg)`;

            segment2.appendChild(segmentInner2);
            chartElement.appendChild(segment2);
        }
    }

    /**
     * í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
     */
    function displayProjects(projects) {
        const projectList = document.querySelector('.project-list');
        if (!projectList) return;

        // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
        projectList.innerHTML = '';

        // í”„ë¡œì íŠ¸ê°€ ì—†ëŠ” ê²½ìš°
        if (!projects || projects.length === 0) {
            const noDataMessage = document.createElement('div');
            noDataMessage.className = 'no-data-message';
            noDataMessage.textContent = 'í‘œì‹œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
            projectList.appendChild(noDataMessage);
            return;
        }

        // ê° í”„ë¡œì íŠ¸ í•­ëª© ìƒì„± ë° ì¶”ê°€
        projects.forEach(project => {
            const projectItem = document.createElement('div');
            projectItem.className = 'project-item';
            if (project.status === 'ì§€ì—°') {
                projectItem.classList.add('delayed-project');
            }

            projectItem.innerHTML = `
            <div class="project-info">
                <div class="project-name">${escapeHtml(project.name)}</div>
                <div class="project-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${project.progress}%"></div>
                    </div>
                    <span class="progress-text">${project.progress}%</span>
                </div>
            </div>
        `;

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ - í”„ë¡œì íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            projectItem.addEventListener('click', function(e) {
                e.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œì˜ í´ë¦­ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                window.location.href = `/workmanagement?projectId=${project.id}`;
            });

            projectList.appendChild(projectItem);
        });
    }

    /**
     * ìµœê·¼ ì—…ë¬´ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
     */
    function displayRecentTasks(tasks) {
        const taskList = document.querySelector('.task-list');
        if (!taskList) return;

        // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
        taskList.innerHTML = '';

        // ì—…ë¬´ê°€ ì—†ëŠ” ê²½ìš°
        if (!tasks || tasks.length === 0) {
            const noDataMessage = document.createElement('li');
            noDataMessage.className = 'no-data-message';
            noDataMessage.textContent = 'í‘œì‹œí•  ìµœê·¼ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.';
            taskList.appendChild(noDataMessage);
            return;
        }

        // ê° ì—…ë¬´ í•­ëª© ìƒì„± ë° ì¶”ê°€
        tasks.forEach(task => {
            const taskItem = document.createElement('li');
            taskItem.className = 'task-item';

            // ìƒíƒœ í…ìŠ¤íŠ¸ ë° í´ë˜ìŠ¤ ê²°ì •
            let statusText = 'ëŒ€ê¸°ì¤‘';
            let statusClass = 'pending';

            if (task.status === 'ì™„ë£Œ') {
                statusText = 'ì™„ë£Œ';
                statusClass = 'completed';
            } else if (task.status === 'ì§„í–‰ì¤‘') {
                statusText = 'ì§„í–‰ì¤‘';
                statusClass = 'in-progress';
            } else if (task.overdue || task.status === 'ì§€ì—°') {
                statusText = 'ì§€ì—°';
                statusClass = 'delayed';
            }

            // ë§ˆê°ì¼ í˜•ì‹í™”
            const formattedDate = formatDueDate(task.dueDate);

            taskItem.innerHTML = `
            <div class="task-info">
                <span class="task-title">${escapeHtml(task.title)}</span>
                <span class="task-date">${formattedDate}</span>
            </div>
            <span class="task-badge ${statusClass}">${statusText}</span>
        `;

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ - ì—…ë¬´ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            taskItem.addEventListener('click', function(e) {
                e.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œì˜ í´ë¦­ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                window.location.href = `/workmanagement?taskId=${task.id}`;
            });

            taskList.appendChild(taskItem);
        });
    }

    /**
     * ë§ˆê°ì¼ í˜•ì‹í™” í•¨ìˆ˜
     */
    function formatDueDate(dateStr) {
        if (!dateStr) return 'ê¸°í•œ ì—†ìŒ';

        const date = new Date(dateStr);
        const now = new Date();
        const diffTime = date.getTime() - now.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));

        // YYYY-MM-DD í˜•ì‹
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

        // ë§ˆê°ì¼ì´ ì§€ë‚¬ìœ¼ë©´ 'ë§ˆê°ì¼ ì§€ë‚¨', ë‹¹ì¼ì´ë©´ 'ì˜¤ëŠ˜ ë§ˆê°', ì•„ë‹ˆë©´ 'Nì¼ ë‚¨ìŒ'
        if (diffDays < 0) {
            return `${formattedDate} (${Math.abs(diffDays)}ì¼ ì§€ë‚¨)`;
        } else if (diffDays === 0) {
            return `${formattedDate} (ì˜¤ëŠ˜ ë§ˆê°)`;
        } else {
            return `${formattedDate} (${diffDays}ì¼ ë‚¨ìŒ)`;
        }
    }

    /**
     * HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ - XSS ë°©ì§€
     */
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

<!-- íšŒì‚¬ ìºëŸ¬ì…€ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
<script th:src="@{/assets/js/main/main-util.js}"></script>
<!--<div th:replace="/assets/js/main/main-util.js"></div>-->

<!-- í—¤ë” ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
<div th:replace="fragments/header :: headerScripts"></div>

<!-- ê³µí†µ ì‚¬ì´ë“œë°” ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
<link rel="stylesheet" th:href="@{/assets/js/fragments/sidebar-common.js}">

</body>
</html>