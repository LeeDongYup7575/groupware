<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>헤더 프래그먼트</title>
</head>
<body>
<!-- 네비게이션 바 -->
<nav th:fragment="header" class="gw-navbar">
    <div class="gw-container">
        <div class="gw-navbar-left">
            <a class="gw-navbar-brand" href="/">
                <span><img src="/assets/images/bigLogo.png" alt="TechX 로고" class="logo-img"></span>
            </a>

            <!-- 현재 페이지 및 전체 메뉴 -->
            <div class="gw-current-page" id="currentPageToggle" style="display: none;">
                <span class="gw-page-title" th:text="${pageTitle ?: '홈'}">홈</span>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>

        <div class="gw-navbar-right">
            <input type="checkbox" id="gw-navbar-toggle" class="gw-navbar-toggle">
            <label for="gw-navbar-toggle" class="gw-navbar-toggle-label">
                <i class="fas fa-ellipsis-v"></i>
            </label>
            <div class="gw-navbar-collapse">
                <ul class="gw-navbar-nav">
                    <li class="gw-nav-item">
                        <a class="gw-nav-link" href="/">홈</a>
                    </li>
                    <li class="gw-nav-item">
                        <a class="gw-nav-link" href="/faq">문의</a>
                    </li>
                    <!-- 알림 메뉴 추가 -->
                    <li class="gw-nav-item gw-notification-dropdown" id="notification-dropdown">
                        <input type="checkbox" id="gw-notification-toggle" class="gw-dropdown-toggle">
                        <label for="gw-notification-toggle" class="gw-dropdown-toggle-label">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                        </label>
                        <div class="gw-dropdown-menu gw-notification-menu" id="notification-menu">
                            <div class="notification-header">
                                <h4>알림</h4>
                                <button type="button" id="mark-all-read-btn" class="mark-all-read-btn">모두 읽음 표시</button>
                            </div>
                            <div class="notification-list" id="notification-list">
                                <!-- 알림 내용이 여기에 동적으로 추가됩니다 -->
                                <div class="no-notifications">새 알림이 없습니다</div>
                            </div>
                        </div>
                    </li>
                    <!-- 로그인 안된 상태일 때 보이는 버튼 -->
                    <li class="gw-nav-item" id="login-button">
                        <a class="gw-btn gw-btn-login" href="/auth/login">로그인</a>
                    </li>
                    <!-- 로그인된 상태일 때 보이는 사용자 메뉴 -->
                    <li class="gw-nav-item gw-user-dropdown" id="user-dropdown" style="display: none;">
                        <input type="checkbox" id="gw-dropdown-toggle" class="gw-dropdown-toggle">
                        <label for="gw-dropdown-toggle" class="gw-dropdown-toggle-label">
                            <i class="fas fa-user-circle"></i>
                            <span id="user-name">사용자</span>
                            <i class="fas fa-chevron-down"></i>
                        </label>
                        <ul class="gw-dropdown-menu">
                            <li><a class="gw-dropdown-item" href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                            <li><a class="gw-dropdown-item" href="/attend/main"><i class="fas fa-clock"></i> 근태관리</a></li>
                            <li><a class="gw-dropdown-item" href="#" onclick="navigateToQRCheck(event)"><i class="fas fa-file-signature"></i>QR</a></li>
                            <li><hr class="gw-dropdown-divider"></li>
                            <li><a class="gw-dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div class="gw-modal-backdrop"></div>
    </div>
</nav>

<!-- CSS 부분 -->
<th:block th:fragment="headerAssets">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style th:fragment="headerCss">
        :root {
            --gw-primary-color: #0183D4;
            --gw-primary-light: #DDF6FF;
            --gw-primary-dark: #0066a8;
            --gw-secondary-color: #f3f4f6;
            --gw-text-color: #1f2937;
            --gw-text-light: #6b7280;
            --gw-accent-color: #f97316;
            --gw-white: #ffffff;
            --gw-box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .gw-container {
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 네비게이션 바 */
        .gw-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background-color: var(--gw-white);
            box-shadow: var(--gw-box-shadow);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .gw-navbar-scrolled {
            height: 60px;
        }

        .gw-navbar .gw-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
        }

        .gw-navbar-left {
            display: flex;
            align-items: center;
        }

        .gw-navbar-right {
            display: flex;
            align-items: center;
        }

        .gw-navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--gw-primary-color);
            text-decoration: none;
            margin-right: 1rem;
        }
        .logo-img{
            height: 50px;
            vertical-align: bottom;
        }

        .gw-accent-color {
            color: var(--gw-accent-color);
        }

        /* 현재 페이지 표시 */
        .gw-current-page {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.4rem 0.8rem;
            background-color: var(--gw-secondary-color);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .gw-current-page:hover {
            background-color: var(--gw-primary-light);
        }

        .gw-page-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }

        .gw-current-page i {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .gw-current-page.active i {
            transform: rotate(180deg);
        }

        /* 임포트된 사이드바 */
        #importedSidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background-color: var(--gw-white);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1010;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding-top: 60px; /* 헤더 높이만큼 여백 */
        }

        #importedSidebar.open {
            left: 0;
        }

        .gw-sidebar-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gw-text-light);
            cursor: pointer;
            transition: color 0.3s ease;
            padding: 0.5rem;
            z-index: 1011;
        }

        .gw-sidebar-close:hover {
            color: var(--gw-text-color);
        }

        /* 토글 버튼 (점 세개 아이콘) */
        .gw-navbar-toggle {
            display: none;
        }

        .gw-navbar-toggle-label {
            display: none;
            cursor: pointer;
            width: 30px;
            height: 30px;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gw-primary-color);
            z-index: 1002;
        }

        /* 네비게이션 메뉴 */
        .gw-navbar-nav {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .gw-nav-item {
            margin-left: 1.5rem;
        }

        .gw-nav-link {
            font-weight: 500;
            font-size: 1rem;
            color: var(--gw-text-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .gw-nav-link:hover {
            color: var(--gw-primary-color);
        }

        /* 버튼 스타일 */
        .gw-btn {
            display: inline-block;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            border-radius: 0.5rem;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .gw-btn-login {
            background-color: var(--gw-white);
            color: var(--gw-primary-color);
            border: 2px solid var(--gw-primary-color);
        }

        .gw-btn-login:hover {
            background-color: var(--gw-primary-color);
            color: var(--gw-white);
        }

        /* 드롭다운 메뉴 */
        .gw-user-dropdown {
            position: relative;
        }

        .gw-dropdown-toggle {
            display: none;
        }

        .gw-dropdown-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: var(--gw-text-color);
        }

        .gw-dropdown-toggle-label i {
            margin-right: 0.5rem;
        }

        .gw-dropdown-toggle-label .fa-chevron-down {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .gw-dropdown-toggle:checked + .gw-dropdown-toggle-label .fa-chevron-down {
            transform: rotate(180deg);
        }

        .gw-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 200px;
            background-color: var(--gw-white);
            border-radius: 0.5rem;
            box-shadow: var(--gw-box-shadow);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            list-style: none;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            z-index: 1001;
        }

        .gw-dropdown-toggle:checked ~ .gw-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .gw-dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: var(--gw-text-color);
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .gw-dropdown-item:hover {
            background-color: var(--gw-primary-light);
        }

        .gw-dropdown-item i {
            margin-right: 0.5rem;
            width: 1rem;
        }

        .gw-dropdown-divider {
            height: 1px;
            background-color: var(--gw-secondary-color);
            border: none;
            margin: 0.5rem 0;
        }

        /* 모달 배경 */
        .gw-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1005;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gw-modal-backdrop.open {
            display: block;
            opacity: 1;
        }

        /* 알림 관련 CSS 추가 */
        .gw-notification-dropdown {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--gw-accent-color);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gw-notification-menu {
            width: 350px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--gw-secondary-color);
        }

        .notification-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .mark-all-read-btn {
            background: none;
            border: none;
            color: var(--gw-primary-color);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .notification-list {
            overflow-y: auto;
            max-height: 300px;
            padding: 0;
        }

        .notification-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--gw-secondary-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: var(--gw-primary-light);
        }

        .notification-item.unread {
            background-color: rgba(1, 131, 212, 0.05);
        }

        .notification-item.unread:hover {
            background-color: rgba(1, 131, 212, 0.1);
        }

        .notification-content {
            font-size: 0.85rem;
            color: var(--gw-text-color);
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--gw-text-light);
        }

        .view-all-link {
            color: var(--gw-primary-color);
            font-size: 0.85rem;
            text-decoration: none;
        }

        .no-notifications {
            padding: 20px;
            text-align: center;
            color: var(--gw-text-light);
            font-size: 0.9rem;
        }

        .notification-type-icon {
            margin-right: 8px;
            width: 16px;
            display: inline-block;
            text-align: center;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .gw-navbar-toggle-label {
                display: flex;
                z-index: 1001;
            }

            .gw-navbar-toggle:checked ~ .gw-container .gw-modal-backdrop {
                display: block;
                opacity: 1;
            }

            .gw-navbar-collapse {
                position: fixed;
                top: calc(80px + 80px + 5vh);
                left: 50%;
                transform: translate(-50%, -50%) scale(0.9);
                width: 80%;
                max-width: 320px;
                max-height: 80vh;
                background-color: var(--gw-white);
                border-radius: 1rem;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
                z-index: -1;
                padding: 1.5rem;
                overflow-y: auto;
                opacity: 0;
                visibility: hidden;
                display: none;
            }

            .gw-navbar-toggle:checked ~ .gw-navbar-collapse {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
                visibility: visible;
                display: block;
                z-index: 1000;
            }

            .gw-navbar-nav {
                flex-direction: column;
                align-items: flex-start;
            }

            .gw-nav-item {
                margin-left: 0;
                margin-bottom: 1rem;
                width: 100%;
            }

            .gw-dropdown-menu {
                position: static;
                box-shadow: none;
                opacity: 1;
                visibility: visible;
                transform: none;
                width: 100%;
                display: none;
                margin-top: 0.5rem;
            }

            .gw-dropdown-toggle:checked ~ .gw-dropdown-menu {
                display: block;
            }

            .gw-notification-menu {
                width: 100%;
            }
        }
    </style>
</th:block>
<th:block th:fragment="headerScripts">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>
        // 스크롤 시 네비게이션바 스타일 변경
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.gw-navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('gw-navbar-scrolled');
            } else {
                navbar.classList.remove('gw-navbar-scrolled');
            }
        });

        // 페이지 로드 시 JWT 토큰 확인하여 로그인 상태 확인
        document.addEventListener('DOMContentLoaded', function() {
            // 로컬 스토리지에서 JWT 토큰 확인
            const token = localStorage.getItem('accessToken');
            const userName = localStorage.getItem('name');

            // 요소들을 변수에 저장하고 존재 여부 확인
            const loginButton = document.getElementById('login-button');
            const userDropdown = document.getElementById('user-dropdown');
            const userNameElement = document.getElementById('user-name');
            const modalBackdrop = document.querySelector('.gw-modal-backdrop');
            const currentPageToggle = document.getElementById('currentPageToggle');
            const notificationDropdown = document.getElementById('notification-dropdown');

            // 사이드바 관련 변수 및 함수들
            let importedSidebar = document.getElementById('importedSidebar');
            const importSidebar = async function() {
                try {
                    // 사이드바가 이미 존재하는지 확인
                    if (!importedSidebar) {
                        const response = await fetch('/fragments/sidebar/main-sidebar');

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const html = await response.text();

                        // 임시 div에 HTML 삽입
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        // sidebar 프래그먼트 추출 및 ID 부여
                        const sidebarElement = tempDiv.querySelector('[th\\:fragment="sidebar"]') ||
                            tempDiv.querySelector('[data-th-fragment="sidebar"]') ||
                            tempDiv.querySelector('#sidebar') ||
                            tempDiv.querySelector('.sidebar');


                        if (sidebarElement) {
                            sidebarElement.id = 'importedSidebar';

                            // 닫기 버튼 추가
                            const closeButton = document.createElement('button');
                            closeButton.className = 'gw-sidebar-close';
                            closeButton.innerHTML = '<i class="fas fa-times"></i>';
                            closeButton.addEventListener('click', closeSidebar);
                            sidebarElement.appendChild(closeButton);

                            // body에 추가
                            document.body.appendChild(sidebarElement);
                            importedSidebar = sidebarElement;
                        } else {
                            console.error('Could not find sidebar fragment in the response');
                        }
                    }
                } catch (error) {
                    console.error('Error importing sidebar:', error);
                }
            };

            // 사이드바 토글 함수
            const toggleSidebar = async function() {
                // 사이드바가 아직 로드되지 않았다면 로드
                if (!importedSidebar) {
                    await importSidebar();
                }

                if (importedSidebar) {
                    importedSidebar.classList.add('open');
                    modalBackdrop.classList.add('open');
                    document.body.style.overflow = 'hidden'; // 배경 스크롤 막기
                }
            };

            // 사이드바 닫기 함수
            const closeSidebar = function() {
                if (importedSidebar) {
                    importedSidebar.classList.remove('open');
                }
                modalBackdrop.classList.remove('open');
                document.body.style.overflow = ''; // 배경 스크롤 복원
            };

            // 현재 페이지 버튼 클릭 이벤트
            if (currentPageToggle) {
                currentPageToggle.addEventListener('click', toggleSidebar);
            }

            // 모달 배경 클릭 이벤트
            if (modalBackdrop) {
                modalBackdrop.addEventListener('click', function() {
                    closeSidebar();
                    closeMenu();
                });
            }

            // 모바일 메뉴 닫기 함수
            function closeMenu() {
                document.getElementById('gw-navbar-toggle').checked = false;
            }

            // 모든 메뉴 링크에 이벤트 리스너 추가
            const navLinks = document.querySelectorAll('.gw-nav-link, .gw-dropdown-item');
            navLinks.forEach(link => {
                link.addEventListener('click', closeMenu);
            });

            if (token) {
                // 토큰이 있으면 로그인된 상태로 처리
                if (loginButton) {
                    loginButton.style.cssText = 'display: none !important;';
                }

                if (userDropdown) {
                    userDropdown.style.cssText = 'display: block !important;';
                }

                // 사용자 이름 표시
                if (userNameElement) {
                    userNameElement.textContent = userName || '사용자';
                }

                if(currentPageToggle){
                    const path = window.location.pathname;

                    if (path === '/main') {
                        currentPageToggle.style.display = 'none';
                    } else {
                        currentPageToggle.style.display = 'block';
                    }
                }

                // 알림 기능 초기화
                if (notificationDropdown) {
                    initializeNotifications();
                }
            } else {
                // 로그인되지 않은 경우 알림 버튼 숨김
                if (notificationDropdown) {
                    notificationDropdown.style.display = 'none';
                }
            }


            // 로그아웃 버튼 클릭 이벤트
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', function(e) {
                    e.preventDefault();

                    // 토큰 가져오기
                    const token = localStorage.getItem('accessToken');

                    // 서버에 로그아웃 요청 보내기
                    fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : '',
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            console.log('로그아웃 응답 상태:', response.status);

                            // 로컬 스토리지에서 토큰 및 사용자 정보 제거
                            localStorage.removeItem('accessToken');
                            localStorage.removeItem('refreshToken');
                            localStorage.removeItem('empNum');
                            localStorage.removeItem('name');
                            localStorage.removeItem('email');
                            localStorage.removeItem('role');

                            // 세션 스토리지도 초기화
                            sessionStorage.clear();

                            // 쿠키 삭제
                            document.cookie = 'accessToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                            document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

                            // 메일 로그아웃
                            window.open(
                                "http://techx.kro.kr:8081/roundcube/?_task=login&_action=force-logout",
                                "roundcubeLogout",
                                "width=1,height=1,top=99999,left=99999,resizable=no,scrollbars=no,status=no,toolbar=no,menubar=no"
                            );

                            // 인트로 페이지로 이동
                            window.location.href = '/';
                        })
                        .catch(error => {
                            console.error('로그아웃 요청 중 오류:', error);

                            // 오류가 발생해도 클라이언트 측 토큰은 제거
                            localStorage.removeItem('accessToken');
                            localStorage.removeItem('refreshToken');
                            localStorage.removeItem('empNum');
                            localStorage.removeItem('name');
                            localStorage.removeItem('email');
                            localStorage.removeItem('role');
                            sessionStorage.clear();

                            // 쿠키 삭제
                            document.cookie = 'accessToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                            document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

                            // 인트로 페이지로 이동
                            window.location.href = '/';
                        });
                });
            }

            // ESC 키로 모달과 사이드바 닫기
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeMenu();
                    closeSidebar();
                }
            });

            // 현재 페이지 제목 설정
            function setPageTitle() {
                // URL에서 페이지 정보 추출
                const path = window.location.pathname;
                let pageTitle = '홈';

                // URL 경로에 따라 페이지 제목 설정
                if (path.includes('/board')) {
                    pageTitle = '게시판';
                } else if (path.includes('/contact')) {
                    pageTitle = '주소록';
                } else if (path.includes('/booking')) {
                    pageTitle = '예약';
                } else if (path.includes('/workmanagement')) {
                    pageTitle = '업무 관리';
                } else if (path.includes('/attend')) {
                    pageTitle = '근태휴가';
                } else if (path.includes('/works')) {
                    pageTitle = '근태휴가';
                } else if (path.includes('/leaves')) {
                    pageTitle = '근태휴가';
                } else if (path.includes('/edsm')) {
                    pageTitle = '전자결재';
                } else if (path.includes('/org')) {
                    pageTitle = '조직도';
                } else if (path.includes('/admin')) {
                    pageTitle = '관리자 페이지';
                } else if (path.includes('/faq')) {
                    pageTitle = 'FAQ';
                } else if (path.includes('/mypage')) {
                    pageTitle = '마이페이지';
                }

                // 페이지 제목 요소 업데이트
                const pageTitleElement = document.querySelector('.gw-page-title');
                if (pageTitleElement) {
                    pageTitleElement.textContent = pageTitle;
                }
            }

            // 현재 페이지 제목 설정 호출
            setPageTitle();

            // 알림 관련 기능
            function initializeNotifications() {
                const notificationBadge = document.getElementById('notification-badge');
                const notificationList = document.getElementById('notification-list');
                const markAllReadBtn = document.getElementById('mark-all-read-btn');

                // 안읽은 알림 개수 가져오기
                fetchUnreadCount();

                // 알림 목록 가져오기
                fetchNotifications();

                // WebSocket 연결 설정
                connectToNotificationWebSocket();

                // 읽음 표시 버튼 이벤트
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        markAllAsRead();
                    });
                }

                // 알림 클릭 이벤트를 위한 이벤트 위임
                if (notificationList) {
                    notificationList.addEventListener('click', function(e) {
                        const notificationItem = e.target.closest('.notification-item');
                        if (notificationItem) {
                            const notificationId = notificationItem.dataset.id;
                            const link = notificationItem.dataset.link;

                            // 알림을 읽음 표시로 변경
                            markAsRead(notificationId);

                            // 링크가 있으면 해당 페이지로 이동
                            if (link) {
                                window.location.href = link;
                            }
                        }
                    });
                }
            }

            // WebSocket 연결 설정
            function connectToNotificationWebSocket() {
                const token = localStorage.getItem('accessToken');
                const empNum = localStorage.getItem('empNum');
                if (!token || !empNum) return;


                const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
                const host = window.location.host; // localhost:8080 또는 배포 도메인

                const socket = new SockJS(`${protocol}://${host}/wss-notification`);
                const stompClient = Stomp.over(socket);

                stompClient.connect({ Authorization: 'Bearer ' + token }, function(frame) {
                    console.log('Connected to notification websocket');

                    // 개인별 알림 구독
                    stompClient.subscribe('/user/' + empNum + '/queue/notifications', function(message) {
                        const notification = JSON.parse(message.body);

                        // 새 알림 추가 및 카운트 업데이트
                        addNewNotification(notification);
                        updateUnreadCount();

                        // 브라우저 알림 표시 (권한 있는 경우)
                        showBrowserNotification(notification);
                    });
                }, function(error) {
                    console.error('Error connecting to notification websocket:', error);
                    // 3초 후 재연결 시도
                    setTimeout(connectToNotificationWebSocket, 3000);
                });
            }

            // 안읽은 알림 개수 가져오기
            function fetchUnreadCount() {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                fetch('/api/notifications/count', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(response => response.json())
                    .then(count => {
                        updateBadgeCount(count);
                    })
                    .catch(error => {
                        console.error('Error fetching notification count:', error);
                    });
            }

            // 알림 목록 가져오기
            function fetchNotifications() {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                fetch('/api/notifications/unread', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(response => response.json())
                    .then(notifications => {
                        renderNotifications(notifications);
                    })
                    .catch(error => {
                        console.error('Error fetching notifications:', error);
                    });
            }

            // 알림 목록 렌더링
            function renderNotifications(notifications) {
                const notificationList = document.getElementById('notification-list');
                if (!notificationList) return;

                if (notifications.length === 0) {
                    notificationList.innerHTML = '<div class="no-notifications">새 알림이 없습니다</div>';
                    return;
                }

                notificationList.innerHTML = '';

                notifications.forEach(notification => {
                    const notificationItem = createNotificationElement(notification);
                    notificationList.appendChild(notificationItem);
                });
            }

            // 알림 요소 생성
            function createNotificationElement(notification) {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification-item' + (notification.isRead ? '' : ' unread');
                notificationItem.dataset.id = notification.id;
                notificationItem.dataset.link = notification.link;

                const typeIcon = getTypeIcon(notification.type);

                const timeAgo = getTimeAgo(new Date(notification.createdAt));

                notificationItem.innerHTML = `
                <div class="notification-content">
                    <span class="notification-type-icon">${typeIcon}</span>
                    ${notification.content}
                </div>
                <div class="notification-time">${timeAgo}</div>
            `;

                return notificationItem;
            }

            // 알림 타입에 따른 아이콘 반환
            function getTypeIcon(type) {
                switch (type) {
                    case 'COMMENT':
                        return '<i class="fas fa-comment"></i>';
                    case 'REPLY':
                        return '<i class="fas fa-reply"></i>';
                    case 'PROJECT':
                        return '<i class="fas fa-project-diagram"></i>';
                    case 'TASK':
                        return '<i class="fas fa-tasks"></i>';
                    case 'BOOKING':
                        return '<i class="fas fa-calendar-check"></i>';
                    case 'APPROVAL':
                        return '<i class="fas fa-file-signature"></i>';
                    default:
                        return '<i class="fas fa-bell"></i>';
                }
            }

            // 시간 표시 (몇 분 전, 몇 시간 전 등)
            function getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);

                if (diffInSeconds < 60) {
                    return '방금 전';
                }

                const diffInMinutes = Math.floor(diffInSeconds / 60);
                if (diffInMinutes < 60) {
                    return `${diffInMinutes}분 전`;
                }

                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) {
                    return `${diffInHours}시간 전`;
                }

                const diffInDays = Math.floor(diffInHours / 24);
                if (diffInDays < 7) {
                    return `${diffInDays}일 전`;
                }

                // 1주일 이상이면 날짜 표시
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }

            // 새 알림 추가
            function addNewNotification(notification) {
                const notificationList = document.getElementById('notification-list');
                if (!notificationList) return;

                // '알림 없음' 메시지 제거
                const noNotificationsEl = notificationList.querySelector('.no-notifications');
                if (noNotificationsEl) {
                    notificationList.removeChild(noNotificationsEl);
                }

                // 새 알림 요소 추가 (맨 위에)
                const notificationItem = createNotificationElement(notification);
                notificationList.insertBefore(notificationItem, notificationList.firstChild);

                // 시각적으로 알림 효과
                setTimeout(() => {
                    notificationItem.style.backgroundColor = '';
                }, 100);
            }

            // 읽음 표시
            function markAsRead(notificationId) {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(() => {
                        // UI 업데이트
                        const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                        }

                        // 안읽은 알림 카운트 업데이트
                        updateUnreadCount();
                    })
                    .catch(error => {
                        console.error('Error marking notification as read:', error);
                    });
            }

            // 모두 읽음 표시
            function markAllAsRead() {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                fetch('/api/notifications/read-all', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(() => {
                        // UI 업데이트
                        const unreadItems = document.querySelectorAll('.notification-item.unread');
                        unreadItems.forEach(item => {
                            item.classList.remove('unread');
                        });

                        // 알림 카운트 초기화
                        updateBadgeCount(0);
                    })
                    .catch(error => {
                        console.error('Error marking all notifications as read:', error);
                    });
            }

            // 안읽은 알림 개수 업데이트
            function updateUnreadCount() {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                fetch('/api/notifications/count', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(response => response.json())
                    .then(count => {
                        updateBadgeCount(count);
                    })
                    .catch(error => {
                        console.error('Error updating notification count:', error);
                    });
            }

            // 알림 뱃지 카운트 업데이트
            function updateBadgeCount(count) {
                const notificationBadge = document.getElementById('notification-badge');
                if (!notificationBadge) return;

                if (count > 0) {
                    notificationBadge.textContent = count > 99 ? '99+' : count;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }
            }

            // 브라우저 알림 표시
            function showBrowserNotification(notification) {
                // 브라우저 알림 권한 확인
                if (Notification.permission === 'granted') {
                    const title = '새로운 알림';
                    const options = {
                        body: notification.content,
                        icon: '/assets/images/favicon.ico'
                    };

                    const browserNotification = new Notification(title, options);

                    // 알림 클릭 시 해당 페이지로 이동
                    browserNotification.onclick = function() {
                        window.focus();
                        if (notification.link) {
                            window.location.href = notification.link;
                        }
                        browserNotification.close();
                    };
                } else if (Notification.permission !== 'denied') {
                    // 권한 요청
                    Notification.requestPermission();
                }
            }
        });

        // QR체크 페이지로 이동하는 함수
        function navigateToQRCheck(event) {
            event.preventDefault();

            // 로컬 스토리지에서 토큰 가져오기
            const token = localStorage.getItem('accessToken');

            if (token) {
                // fetch API를 사용하여 헤더에 토큰을 포함시켜 요청
                fetch('/qr/qrcheck', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(response => {
                        if (response.redirected) {
                            // 리다이렉션이 있으면 해당 URL로 이동
                            window.location.href = response.url;
                        } else if (response.ok) {
                            // 응답이 HTML이면 전체 페이지를 그 내용으로 대체
                            return response.text().then(html => {
                                document.open();
                                document.write(html);
                                document.close();
                            });
                        } else {
                            console.error('QR 체크 페이지 로드 오류:', response.status);
                            alert('QR 체크 페이지를 로드할 수 없습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('QR 체크 페이지 요청 오류:', error);
                        alert('QR 체크 페이지 요청 중 오류가 발생했습니다.');
                    });
            } else {
                // 토큰이 없으면 인트로 페이지로 리다이렉트
                window.location.href = '/';
            }
        }

        // 채팅 창 열기 함수
        function openChat() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("로그인이 필요합니다");
                return;
            }

            // 새 창 열기
            const url = `http://10.10.55.57:3000?token=${encodeURIComponent(token)}`;
            // const url = `http://192.168.1.175:3000?token=${encodeURIComponent(token)}`;
            const newWindow = window.open(url, "_blank");

            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                alert("팝업이 차단되었습니다. 팝업 허용을 해주세요.");
            }
        }
    </script>
</th:block>
</body>
</html>
